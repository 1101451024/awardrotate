var Preload=function(e){"use strict";this.opts={sources:null,progress:function(){},connector:null,completeLoad:function(){},config:{timeOut:e.loadingOverTime||15,timeOutCB:e.loadingOverTimeCB||function(){}}};this.params={echetotal:0,echelon:[],echelonlen:[],echeloncb:[],id:0,flag:0,allowType:["jpg","jpeg","png","gif"],total:0,completedCount:0,_createXHR:null,imgNode:[],imgNodePSrc:[],audioNode:[],audioNodePSrc:[],head:document.getElementsByTagName("head")[0]};for(var t in e){this.opts[t]=e[t]}this._init()};Preload.prototype={_init:function(){var e=this,t=e.opts,o=e.params;e._initData();if(t.connector!==null){e._getData()}e._load(o.echelon[0],o.echeloncb[0],o.echelonlen)},_initData:function(){var e=this,t=e.opts,o=e.params;if(t.sources===null)return;o.echetotal=Object.getOwnPropertyNames(t.sources).length;for(var a in t.sources){for(var r=0,n=t.sources[a].source.length;r<n;r++){o.echelon.push(t.sources[a].source[r])}o.echelonlen.push(t.sources[a].source.length);o.echeloncb.push(typeof t.sources[a].callback=="undefined"?null:t.sources[a].callback)}o._createXHR=e.getXHR();for(var a=1,n=o.echelonlen.length;a<n;a++){o.echelonlen[a]=o.echelonlen[a-1]+o.echelonlen[a]}o.total=o.echelon.length;o.imgNode=document.getElementsByTagName("img");for(var a=0,n=o.imgNode.length;a<n;a++){if(o.imgNode[a].attributes.pSrc){o.imgNodePSrc[a]=o.imgNode[a].attributes.pSrc.value}}o.audioNode=document.getElementsByTagName("audio");for(var a=0,n=o.audioNode.length;a<n;a++){if(o.audioNode[a].attributes.pSrc){o.audioNodePSrc[a]=o.audioNode[a].attributes.pSrc.value}}},_load:function(e,t,o){var a=this,r=a.opts,n=a.params;if(n.id>=o[n.flag]){if(n.echeloncb[n.flag]!=null){n.echeloncb[n.flag]()}++n.flag}if(n.id>=n.total){r.completeLoad();return}if(a.isImg(e)){var c=new Image;var l=setTimeout(function(){r.config.timeOutCB()},r.config.timeOut*1e3);c.src=e;c.onload=function(){clearTimeout(l);r.progress(++n.completedCount,n.total);for(var c=0,i=n.imgNodePSrc.length;c<i;c++){if(n.imgNodePSrc[c]==e){n.imgNode[c].src=n.imgNodePSrc[c];break}}a._load(n.echelon[++n.id],t,o)};c.onerror=function(){r.progress(++completedCount,total);a._load(n.echelon[++n.id],t,o)}}else{n._createXHR.onreadystatechange=function(){if(n._createXHR.readyState==4){if(n._createXHR.status>=200&&n._createXHR.status<300||n._createXHR.status===304){r.progress(++n.completedCount,n.total);for(var c=0,l=n.audioNodePSrc.length;c<l;c++){if(n.audioNodePSrc[c]==e){n.audioNode[c].src=n.audioNodePSrc[c];break}}a._load(n.echelon[++n.id],t,o)}}else if(n._createXHR.status>=400&&n._createXHR.status<500){r.progress(++n.completedCount,n.total);a._load(n.echelon[++n.id],t,o)}};n._createXHR.open("GET",e,true);n._createXHR.send(null)}},_getData:function(){var e=this,t=e.opts,o=e.params;for(var a in t.connector){if(t.connector[a].jsonp){e.asynGetData(t.connector[a].url)}else{e.syncGetData(t.connector[a].url,t.connector[a].callback)}}},syncGetData:function(e,t){var o=this,a=o.opts,r=o.params;r._createXHR.onreadystatechange=function(){if(r._createXHR.readyState==4){if(r._createXHR.status>=200&&r._createXHR.status<300||r._createXHR.status===304){t(r._createXHR.responseText)}}};r._createXHR.open("GET",e,true);r._createXHR.send(null)},asynGetData:function(e){var t=this,o=t.opts,a=t.params;var r=document.createElement("script");r.src=e;a.head.appendChild(r)},getXHR:function(){if(typeof XMLHttpRequest!="undefined"){return new XMLHttpRequest}else if(typeof ActiveXObject!="undefined"){if(typeof arguments.callee.activeXString!="string"){var e=["MSXML2.XMLHttp.6.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp"],t,o;for(t=0,o=e.length;t<o;t++){try{new ActiveXObject(e[t]);arguments.callee.activeXString=e[t];break}catch(e){}}}return new ActiveXObject(arguments.callee.activeXString)}else{throw new Error("No XHR object available.")}},isImg:function(e){var t=this,o=t.opts,a=t.params,r=e.split(".").pop();for(var n=0,c=a.allowType.length;n<c;n++){if(r==a.allowType[n])return true}return false}};if(typeof module=="object"){module.exports=Preload}else{window.Preload=Preload}